## 总览
- 目标：逐项完成阶段 2 的改进项，每项完成功能开发→接口与 UI 验证→测试通过后再进入下一项。
- 交付：每项独立提交、最小改动可回滚、确保安全与一致性。

## 顺序与粒度
1. 自定义模型 CRUD（后端接口 + 设置页 UI）
2. Model Hub 分组与健康指示（分组展示 + 错误文案）
3. Agent Smart Generate（后端生成端点 + 编辑器按钮）
4. MCP 详情视图（工具明细 + 错误原因 + 重试）
5. 指令系统完善（/help 扩展、/note 标题输入、统一提示）
6. Agent 工具 ID 全量迁移（“server:name”一致化）
7. 测试覆盖扩展（错误用例与回归）

## 任务 1：自定义模型 CRUD
- 后端
  - 新增配置结构：llm.custom_models[]（name、base_url、api_key、model）。
  - 新增接口：GET/POST/PUT/DELETE /api/models/custom；沿用“GET 脱敏、POST 忽略空/遮罩值”。
  - 新增 POST /api/models/test/custom（按 custom model 字段测试连接）。
- 前端
  - Settings → LLM Tab 增加“Custom”分组卡片与新增/编辑/删除对话框；集成“Test Connection”。
- 测试
  - 接口：创建→列表→编辑→删除闭环；错误参数校验；健康测试超时与错误文案。
  - UI：对话框操作与状态反馈一致；GET 不泄露密钥。
- 验收标准
  - CRUD 功能完整、连接测试准确、错误提示清晰。

## 任务 2：Model Hub 分组与健康指示
- 前端
  - Provider 卡片分组（Premium/Advanced/Custom）。
  - 健康状态徽标与错误详情折叠区；调用 test 端点更新状态。
- 测试
  - 模拟缺失 key/错误 base_url，观察状态与错误文案；反复测试更新状态。
- 验收标准
  - 分组清晰、健康反馈直观、错误可定位。

## 任务 3：Agent Smart Generate
- 后端
  - 新增 POST /api/agents/smart_generate（入参：目标/约束/语气/工具列表；返回：prompt 与建议说明）。
  - 失败处理：无配置或模型不可用时返回友好错误。
- 前端
  - Agents 编辑器增加“Smart Generate”按钮与结果预览/一键替换。
- 测试
  - 接口：多场景入参、失败分支；
  - UI：生成质量与响应时间、替换后保存正确。
- 验收标准
  - 稳定生成、结果可采纳、错误提示明确。

## 任务 4：MCP 详情视图
- 前端
  - MCP 卡片展开：显示工具列表、last_error、重试按钮（触发 /api/mcp/reload）。
- 测试
  - 人为制造错误（命令/路径），验证错误展示与重试恢复；工具列表随连接变化更新。
- 验收标准
  - 详情可见、错误可诊断并可恢复。

## 任务 5：指令系统完善
- 前端
  - /help 展示完整指令与说明；/note 支持标题输入（空标题自动摘要）；统一轻提示（成功/失败）。
- 测试
  - 指令互不干扰输入体验；提示样式一致；保存笔记成功可在 Notebook 列表看到。
- 验收标准
  - 指令可用、提示一致、无交互冲突。

## 任务 6：Agent 工具 ID 全量迁移
- 后端
  - list/更新时执行迁移：name → 唯一映射到“server:name”；多服务器同名工具保留歧义并提示选择。
  - 提供一次性迁移脚本或开关（仅在用户确认后执行）。
- 测试
  - 含多服务器同名工具数据集的迁移与调用正确性；
  - 迁移后 Agents 与 Chat 工具调用稳定。
- 验收标准
  - 数据一致、无误映射、调用正确。

## 任务 7：测试覆盖扩展
- 后端
  - 增加 MCP 配置校验错误用例、自定义模型 CRUD 回归、Smart Generate 参数校验与失败分支。
- 前端
  - 更新手动验收清单；后续可接入轻量 E2E（Playwright）以覆盖关键流程。
- 验收标准
  - 新增用例通过、回归稳定。

## 风险与缓解
- 密钥风险：延续“GET 脱敏、POST 忽略空/遮罩值”；
- 多 Provider 可用性：统一健康测试超时与错误文案；
- 工具歧义：优先使用 composite ID；必要时提示用户选择。

## 执行节奏
- 按顺序逐项完成；每项完成后立刻进行接口与 UI 测试，验收通过再进入下一项；每项独立提交变更说明与回滚方案。